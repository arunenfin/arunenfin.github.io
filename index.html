<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>Agora RTM</title>
  </head>
  <body>
    <h1>Agora RTM</h1>
    <p>This is for testing Agora RTM</p>
    <p id="messages"></p>

    <!-- Optional JavaScript -->
    <script src="./libs/agora-rtm-sdk-1.2.1.js"></script>
    <script>
      const messagesDiv = document.getElementById("messages");

      const addMessage = (msg) => {
        const div = document.createElement("div");
        div.innerHTML = msg;
        messagesDiv.appendChild(div);
      }

      const client = AgoraRTM.createInstance('5a806f727de346f4b06b567ad1a64036', { enableLogUpload: false });
      client.login({uid: "wsdfe", token: "0065a806f727de346f4b06b567ad1a64036IADhuEFhyWDTxPxQVPSH3utfJ6P0s52mn7s6TBGXhbkjM7r++7UAAAAAEAAFZYx1gfn8XQEA6AOB+fxd"})
      .then(console.log)
      .catch(e => {
        addMessage(e.message)
      })

      client.on("ConnectionStateChanged", (newState, reason) => {
        addMessage("ConnectionStateChanged: newState: " + newState + ", reason: " + reason);

        if (rtm.channels[params.channelName] || (rtm.channels[params.channelName] && rtm.channels[params.channelName].joined)) {
          return;
        }

        client.joinChannel("test_channel").then(() => {
          client.channels[params.channelName].joined = true;
          addMessage(rtm.accountName + " join test_channel success");
        }).catch((err) => {
          addMessage("Join channel failed, please open console see more details.");
          console.error(err)
        })
      })

      client.on("MemberJoined", ({channelName, args}) => {
        const memberId = args[0];
        addMessage("MemberJoined: channel "+channelName+" member: "+memberId+" joined");
      });

      client.on("MemberLeft", ({channelName, args}) => {
        const memberId = args[0];
        addMessage("MemberLeft: channel "+channelName+" member: "+memberId+" left");
      });

      client.on("ChannelMessage", ({channelName, args}) => {
        const [message, memberId] = args;
        addMessage("ChannelMessage: channel "+channelName+", messsage: "+message.text+", memberId: "+memberId);
      });

      client.on("MessageFromPeer", (message, peerId) => {
        addMessage("message "+ message.text + " peerId" + peerId);
      });
    </script>
  </body>
</html>