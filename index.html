<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>Agora RTM</title>
  </head>
  <body>
    <h1>Agora RTM</h1>
    <p>This is for testing Agora RTM</p>
    <input id="textip" type="text" />
    <p id="messages"></p>

    <!-- Optional JavaScript -->
    <script src="./libs/agora-rtm-sdk-1.2.1.js"></script>
    <script>
      const messagesDiv = document.getElementById("messages");
      const textinput = document.getElementById("textip");
      const channelId = "test_channel";
      const appId = '5a806f727de346f4b06b567ad1a64036';
      let uid = "wsdfe";
      let token = "0065a806f727de346f4b06b567ad1a64036IADhuEFhyWDTxPxQVPSH3utfJ6P0s52mn7s6TBGXhbkjM7r++7UAAAAAEAAFZYx1gfn8XQEA6AOB+fxd";
      let timer = null;

      if(!window.location.host) {
        uid = "ert";
        token = "0065a806f727de346f4b06b567ad1a64036IAAnVt705asVjVZI+dxeSSK0bi+fqZl7AptXwIWPs4cX1Ih+PPsAAAAAEAAFZYx10v/8XQEA6APS//xd"
      }

      const addMessage = (msg) => {
        const div = document.createElement("div");
        div.innerHTML = msg;
        messagesDiv.appendChild(div);
      }

      textinput.addEventListener('keyup', () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          channel.sendMessage({ text: textinput.value }).then(() => {
            addMessage("message sent")
          }).catch(error => {
            addMessage(error.message)
          })
        }, 1000)
      })

      const client = AgoraRTM.createInstance(appId, { enableLogUpload: false });
      const channel = client.createChannel(channelId);
      client.login({uid: uid, token: token})
      .then(console.log)
      .catch(e => {
        addMessage(e.message)
      })

      client.on("ConnectionStateChanged", (newState, reason) => {
        addMessage("ConnectionStateChanged: newState: " + newState + ", reason: " + reason);

        if(newState === "CONNECTED") {
          channel.join().then(() => {
            addMessage(uid + " join "+channelId+" success");
          }).catch((err) => {
            addMessage("Join channel failed, please open console see more details.");
            console.error(err)
          })
        }
      })

      channel.on("MemberJoined", memberId => {
        addMessage("MemberJoined: channel "+channelId+" member: "+memberId+" joined");
      });

      channel.on("MemberLeft", memberId => {
        addMessage("MemberLeft: channel "+channelId+" member: "+memberId+" left");
      });

      channel.on("ChannelMessage", (message, memberId) => {
        addMessage("ChannelMessage: channel "+channelId+", messsage: "+message.text+", memberId: "+memberId);
      });

      client.on("MessageFromPeer", (message, peerId) => {
        addMessage("message "+ message.text + " peerId" + peerId);
      });
    </script>
  </body>
</html>